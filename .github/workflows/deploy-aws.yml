name: Deploy Database Migrations (AWS RDS)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run migrations against RDS
        env:
          RDS_HOST: ${{ secrets.RDS_HOST }}
          RDS_PORT: ${{ secrets.RDS_PORT }}
          RDS_DB: ${{ secrets.RDS_DB }}
          RDS_USER: ${{ secrets.RDS_USER }}
          RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}
        run: |
          docker run --rm \
            -e PGPASSWORD="$RDS_PASSWORD" \
            -v "${PWD}/db/migrations:/migrations" \
            postgres:15-alpine \
            sh -c '
              for migration in $(ls -1 /migrations/*.sql | sort); do
                echo "Applying ${migration}";
                psql --host="$RDS_HOST" --port="${RDS_PORT:-5432}" --username="$RDS_USER" --dbname="$RDS_DB" --file="$migration";
              done
            '
